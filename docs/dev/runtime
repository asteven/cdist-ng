# @see http://en.wikipedia.org/wiki/Runtime_system

import os
import asyncio
import tempfile
import logging
logging.basicConfig(level=logging.ERROR, format='%(levelname)s: %(message)s')

log = logging.getLogger('cdist')
log.setLevel(logging.DEBUG)

from cdist import session
from cdist import runtime


_session = session.Session()
_session.add_conf_dir(os.path.expanduser('~/vcs/cdist/cdist/conf'))
_session.add_conf_dir(os.path.expanduser('~/.cdist'))
_session.add_conf_dir(os.path.expanduser('~/vcs/cdist-ng/conf'))

#url = 'ssh+sudo+chroot://root@netboot-dev.ethz.ch/local/nfsroot/preos'
url = 'ssh://sar@localhost/tmp/foobar'
_session.add_target(url)
# override remote-cache-dir for testing
_remote_session_dir = tempfile.mkdtemp(prefix='cdist-remote-')
_session['remote-cache-dir'] = os.path.join(_remote_session_dir, _session['session-id'])

_session_dir = tempfile.mkdtemp(prefix='cdist-session-')
_session.to_dir(_session_dir)

_target = _session.targets[0]

_runtime = runtime.Runtime(_session, _target, _session_dir)

loop = asyncio.get_event_loop()

#loop.run_until_complete(_runtime.transfer_global_explorers())
#loop.run_until_complete(_runtime.run_global_explorer('disks'))
#loop.run_until_complete(_runtime.run_global_explorer('memory_size'))

loop.run_until_complete(_runtime.run_global_explorers())

_target


# manually create a object to have something to work with
_type = _runtime.get_type('__service')
_object = _type('foobard', parameters={'enabled': True, 'running': True})
_object_dir = _runtime.get_object_path(_object, 'local')
os.makedirs(_object_dir)
_object.to_dir(_object_dir)

#loop.run_until_complete(_runtime.transfer_type_explorers(_type))
#loop.run_until_complete(_runtime.transfer_object_parameters(_object))

loop.run_until_complete(_runtime.run_type_explorers(_object))

loop.run_until_complete(_runtime.run_initial_manifest())

