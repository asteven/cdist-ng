# @see http://en.wikipedia.org/wiki/Runtime_system

import os
import asyncio
import tempfile
import logging
logging.basicConfig(level=logging.DEBUG, format='%(levelname)s: %(message)s')

from cdist import session
from cdist import runtime


_session = session.Session()
#_session.add_conf_dir(os.path.expanduser('~/vcs/cdist/cdist/conf'))
#_session.add_conf_dir(os.path.expanduser('~/.cdist'))
_session.add_conf_dir(os.path.expanduser('~/vcs/cdist-ng/conf'))

#url = 'ssh+sudo+chroot://root@netboot-dev.ethz.ch/local/nfsroot/preos'
url = 'ssh://sar@localhost/tmp/foobar'
_session.add_target(url)
# override remote-cache-dir for testing
_remote_session_dir = tempfile.mkdtemp(prefix='cdist-remote-')
_session['remote-cache-dir'] = os.path.join(_remote_session_dir, _session['session-id'])

_session_dir = tempfile.mkdtemp(prefix='cdist-session-')
_session.to_dir(_session_dir)

_target = _session.targets[0]

_runtime = runtime.Runtime(_session, _target, _session_dir)

loop = asyncio.get_event_loop()

loop.run_until_complete(_runtime.transfer_global_explorers())

loop.run_until_complete(_runtime.run_global_explorer('disks'))
loop.run_until_complete(_runtime.run_global_explorer('memory_size'))

loop.run_until_complete(_runtime.run_global_explorers())
_target
